import{INCOGNITO_IMAGE,MUTED_SPEAKER,SPEAKER,ARROW_DOWN,ARROW_UP,ENTER_KEY,ARROW_LEFT,ARROW_RIGHT,CLOSE_BUTTON}from './consts.js';const App={currentWindowId:null,windowCounter:0,listOfTabs:[],highlightedTab:-1,isInFilterMode:false,filteredResultsLength:0,tabsCount:0,init:async function(){this.registerEvents();this.listOfTabs=await this.getTabsList();this.displayList({tabsList:this.listOfTabs});document.querySelector('.filterBox').focus();this.tabsCount=this.calcTabsCount({groupOfTabs:this.listOfTabs})},getTabsList:function(){return new Promise(resolve=>{chrome.windows.getAll({populate:true},listOfWindows=>{resolve(listOfWindows)})})},registerEvents:function(){const tabList=document.querySelector('.tab-list');const filterBox=document.querySelector('.filterBox');tabList.addEventListener('click',this.onTabListClick.bind(this));tabList.addEventListener('mousedown',this.onMouseDown.bind(this));filterBox.addEventListener('keyup',this.filterTabs.bind(this));document.querySelector('.remove-filter').addEventListener('click',this.clearFilter.bind(this));document.querySelector('body').addEventListener('keyup',this.onKeyboardButtonPress.bind(this));document.querySelector('body').addEventListener('mousemove',this.onMouseMove.bind(this))},onMouseMove:function(){this.setHightlitedTab({set:false})},displayList:function({tabsList}){const tabListDomElement=document.querySelector('.tab-list');tabsList.forEach((chromeWindow,index)=>{const tabRowFragment=document.createDocumentFragment();chromeWindow.tabs.forEach(tab=>{tabRowFragment.appendChild(this.buildTabRow({tab}))});if(tabsList.length>1&&chromeWindow.tabs.length>0){const group=this.buildWindowsGroup({chromeWindow,tabRowFragment,windowIndex:index+1});tabListDomElement.appendChild(group)}else{tabListDomElement.appendChild(tabRowFragment)}})},buildWindowsGroup:function({chromeWindow,tabRowFragment,windowIndex}){const group=document.createElement('div');group.className=`group ${chromeWindow.incognito?'incognito':''}`;const groupTitle=document.createElement('div');groupTitle.className='group-title';const currentWindowId=chromeWindow.tabs.length>0?chromeWindow.tabs[0].windowId:windowIndex;groupTitle.innerHTML=`window ${ windowIndex }`;if(chromeWindow.incognito){const img=document.createElement('img');img.src=INCOGNITO_IMAGE.src;img.style.width=INCOGNITO_IMAGE.width;img.className=INCOGNITO_IMAGE.className;groupTitle.appendChild(img)}group.dataset.groupId=currentWindowId;if(chromeWindow.tabs.length>0){group.appendChild(groupTitle)}group.appendChild(tabRowFragment);return group},buildTabRow:function({tab}){const active=tab.active?'active':'';const tabRow=document.createElement('div');tabRow.className=`tab-row ${ active }`;tabRow.dataset.tabId=tab.id;tabRow.dataset.windowId=tab.windowId;const favIcon=this.createFavIcon({tab});tabRow.appendChild(favIcon);const tabTitle=this.createTabTitle({tab});tabRow.appendChild(tabTitle);const closeButtonDiv=this.createCloseButtonDiv();tabRow.appendChild(closeButtonDiv);return tabRow},createTabTitle:function({tab}){const tabTitle=document.createElement('div');tabTitle.className='tab-title';const speakerSpan=this.createSpeakerIcon({tab});tabTitle.appendChild(speakerSpan);const tabDesc=document.createElement('span');tabDesc.className='tab-desc';tabDesc.innerText=tab.title;tabTitle.appendChild(tabDesc);return tabTitle},createFavIcon:function({tab}){const favIcon=document.createElement('div');favIcon.className='favicon';const favIconImage=document.createElement('img');favIconImage.src=tab.favIconUrl;favIcon.appendChild(favIconImage);return favIcon},createCloseButtonDiv:function(){const closeButtonDiv=document.createElement('div');closeButtonDiv.className='close-button';closeButtonDiv.dataset.type='closeButton';const closeButtonImage=document.createElement('img');closeButtonImage.src=CLOSE_BUTTON.src;closeButtonImage.dataset.type=CLOSE_BUTTON.type;closeButtonDiv.appendChild(closeButtonImage);return closeButtonDiv},createSpeakerIcon:function(params){const{tab}=params;const speakerVisible=!tab.audible?'hidden':'';let speakerImg;let mutedSpeakerImg;if(tab.audible){speakerImg=`display: ${tab.mutedInfo.muted?'none':'block'}`;mutedSpeakerImg=`display: ${tab.mutedInfo.muted?'block':'none'}`}else{speakerImg='display: none';mutedSpeakerImg='display:none'}const speakerSpan=document.createElement('span');speakerSpan.className=`speaker ${ speakerVisible }`;const speakerImage=document.createElement('img');speakerImage.src=SPEAKER.src;speakerImage.alt=SPEAKER.alt;speakerImage.dataset.type=SPEAKER.type;speakerImage.style=speakerImg;speakerSpan.append(speakerImage);const mutedSpeakerImgElement=document.createElement('img');mutedSpeakerImgElement.src=MUTED_SPEAKER.src;mutedSpeakerImgElement.alt=MUTED_SPEAKER.alt;mutedSpeakerImgElement.dataset.type=MUTED_SPEAKER.type;mutedSpeakerImgElement.style=mutedSpeakerImg;speakerSpan.append(speakerImage);speakerSpan.append(mutedSpeakerImgElement);return speakerSpan},clearFilter:function(){document.querySelector('.filterBox').value='';document.querySelector('.tab-list').innerHTML='';this.displayList({tabsList:this.listOfTabs});this.isInFilterMode=false},onMouseDown:function(event){const isMiddleButtonDown=event.which===2;if(isMiddleButtonDown){const{tabId}=this.getTabData(event);this.removeTabFromList(tabId);this.closeTab(tabId)}},onTabListClick:function(event){if(event.target.id==='tabList'){return}const{tabId,windowId}=this.getTabData(event);const tagName=event.target.tagName.toLowerCase();const type=event.target.dataset.type;if(tagName==='img'&&type==='speaker'){this.toggleMute(tabId);return}if((tagName==='img'||tagName==='div')&&type==='closeButton'){this.removeTabFromList(tabId);this.closeTab(tabId)}else{this.setActiveTab({tabId,windowId})}},toggleMute:function(tabId){chrome.tabs.get(tabId,tabData=>{const muted=!tabData.mutedInfo.muted;chrome.tabs.update(tabId,{muted:muted});this.toggleMuteIcon(tabId,muted)})},setActiveTab:function({tabId,windowId}){chrome.windows.update(windowId,{focused:true},function(){this.selectedWindowId=windowId});chrome.tabs.update(tabId,{active:true})},unregisterEvents:function(){document.querySelector('.tab-list').removeEventListener('click',this.onTabListClick);document.querySelector('.filterBox').removeEventListener('keyup',this.filterTabs);document.querySelector('.remove-filter').removeEventListener('click',this.clearFilter);window.removeEventListener('mousemove',this.onMouseMove)},getTabData:function(event){let currentElement=event.target;let elementType=currentElement.tagName.toLowerCase();while(elementType!=='div'||(elementType==='div'&&!currentElement.classList.contains('tab-row'))){currentElement=currentElement.parentNode;elementType=currentElement.tagName.toLowerCase()}return{tabId:parseInt(currentElement.dataset.tabId),windowId:parseInt(currentElement.dataset.windowId)}},closeTab:function(tabId){chrome.tabs.remove(tabId);this.tabsCount=this.calcTabsCount({groupOfTabs:this.listOfTabs})},removeTabFromList:function(tabId){const list=[...document.querySelectorAll('.tab-row')];const tab=list.find(tab=>parseInt(tab.dataset.tabId)===parseInt(tabId));const group=tab.parentElement;if(!group){document.querySelector('.tab-list').removeChild(tab)}else{group.removeChild(tab);const children=[...group.children];const hasTabs=children.some(htmlElement=>htmlElement.classList.contains('tab-row'));if(!hasTabs){document.querySelector('.tab-list').removeChild(group)}}},toggleMuteIcon:function(tabId,muted){const list=[...document.querySelectorAll('.tab-row')];const tab=list.find(tab=>parseInt(tab.dataset.tabId)===parseInt(tabId));const tabTitle=tab.children[1];tabTitle.children[0].children[0].style.display=muted?'none':'block';tabTitle.children[0].children[1].style.display=muted?'block':'none'},filterTabs:function(event){const{keyCode}=event;if(keyCode===ARROW_DOWN||keyCode===ARROW_UP||keyCode===ENTER_KEY||keyCode===ARROW_LEFT||keyCode===ARROW_RIGHT){return}const valueToFilterBy=event.target.value.toLowerCase();const filteredList=this.listOfTabs.map(group=>{const tabs=group.tabs.filter(tab=>{return(tab.title.toLowerCase().indexOf(valueToFilterBy)>-1||tab.url.toLowerCase().indexOf(valueToFilterBy)>-1)});return Object.assign({},group,{tabs})});this.displayFilteredList(filteredList);this.highlightedTab=-1;this.isInFilterMode=true;this.filteredResultsLength=this.calcTabsCount({groupOfTabs:filteredList})},onKeyboardButtonPress:function(event){const{keyCode}=event;if(keyCode===ARROW_DOWN||keyCode===ARROW_UP||keyCode===ENTER_KEY){switch(keyCode){case ENTER_KEY:{const{tabId,windowId}=document.querySelectorAll('.tab-row')[this.highlightedTab].dataset;const params={tabId:parseInt(tabId),windowId:parseInt(windowId)};this.setActiveTab(params);break}case ARROW_UP:{this.highlightPreviousTab();break}case ARROW_DOWN:{this.highlightNextTab();break}}}},highlightNextTab:function(){if(this.isInFilterMode){if(this.highlightedTab+1<=this.filteredResultsLength-1){this.highlightedTab+=1;this.setHightlitedTab({set:true})}}else{if(this.highlightedTab+1<this.tabsCount-1){this.highlightedTab+=1;this.setHightlitedTab({set:true})}}},highlightPreviousTab:function(){if(this.highlightedTab>0){this.highlightedTab-=1;this.setHightlitedTab({set:true})}},calcTabsCount:function({groupOfTabs}){if(groupOfTabs.length===1){return groupOfTabs[0].tabs.length}let total=0;const totalTabsNumber=groupOfTabs.reduce((tabCount,currentValue)=>{return tabCount+currentValue.tabs.length},total);return totalTabsNumber},setHightlitedTab:function({set}){const tabRowsList=document.querySelectorAll('.tab-row');tabRowsList.forEach(element=>element.classList.remove('hightlighted'));if(set){tabRowsList[this.highlightedTab].classList.add('hightlighted');tabRowsList[this.highlightedTab].scrollIntoView({behavior:'smooth',block:'nearest'})}},displayFilteredList:function(filteredListOfTabs){const tabListDomElement=document.querySelector('.tab-list');tabListDomElement.innerHTML='';this.displayList({tabsList:filteredListOfTabs})}};export default App;